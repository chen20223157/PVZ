<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>v4.0 ç« èŠ‚ç³»ç»Ÿæµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 20px;
    }
    
    .header h1 {
      font-size: 36px;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 18px;
      opacity: 0.9;
    }
    
    #gameCanvas {
      box-shadow: 0 10px 50px rgba(0,0,0,0.5);
      border-radius: 10px;
      background: #000;
      cursor: pointer;
    }
    
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
    }
    
    .btn-secondary {
      background: #2196F3;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #0b7dda;
    }
    
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    
    .btn-warning:hover {
      background: #e68900;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-danger:hover {
      background: #da190b;
    }
    
    .info-panel {
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      max-width: 1200px;
      width: 100%;
    }
    
    .info-panel h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .info-card {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    
    .info-card h4 {
      margin-bottom: 10px;
      color: #4CAF50;
      font-size: 16px;
    }
    
    .info-card p {
      margin: 5px 0;
      color: #666;
      font-size: 14px;
    }
    
    .info-card .value {
      font-weight: bold;
      color: #333;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: none;
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }
    
    .toast.show {
      display: block;
    }
    
    .toast.error {
      background: #f44336;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ® v4.0 ç« èŠ‚ç³»ç»Ÿæµ‹è¯•</h1>
    <p>æµ‹è¯•æ–°çš„å¤šç« èŠ‚å…³å¡ç³»ç»Ÿ</p>
  </div>

  <canvas id="gameCanvas" width="1200" height="800"></canvas>

  <div class="controls">
    <button class="btn btn-primary" onclick="toggleChapterSelect()">ğŸ“‹ æ˜¾ç¤º/éšè—ç« èŠ‚é€‰æ‹©</button>
    <button class="btn btn-secondary" onclick="showProgress()">ğŸ“Š æŸ¥çœ‹è¿›åº¦</button>
    <button class="btn btn-secondary" onclick="showUnlockedPlants()">ğŸŒ± æŸ¥çœ‹å·²è§£é”æ¤ç‰©</button>
    <button class="btn btn-warning" onclick="completeCurrentLevel()">âœ“ æ¨¡æ‹Ÿå®Œæˆå½“å‰å…³å¡</button>
    <button class="btn btn-danger" onclick="resetProgress()">ğŸ—‘ï¸ é‡ç½®è¿›åº¦</button>
  </div>

  <div class="info-panel">
    <h3>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h3>
    <div class="info-grid">
      <div class="info-card">
        <h4>ğŸ’° é‡‘å¸</h4>
        <p>å½“å‰é‡‘å¸: <span class="value" id="currentCoins">0</span></p>
        <p>ç´¯è®¡è·å¾—: <span class="value" id="totalCoins">0</span></p>
      </div>
      <div class="info-card">
        <h4>â­ æ˜Ÿæ˜Ÿ</h4>
        <p>æ€»æ˜Ÿæ•°: <span class="value" id="totalStars">0</span></p>
        <p>æ»¡æ˜Ÿå…³å¡: <span class="value" id="perfectLevels">0</span></p>
      </div>
      <div class="info-card">
        <h4>ğŸ¯ è¿›åº¦</h4>
        <p>å½“å‰ç« èŠ‚: <span class="value" id="currentChapter">1</span></p>
        <p>å·²å®Œæˆ: <span class="value" id="completedLevels">0</span></p>
      </div>
      <div class="info-card">
        <h4>ğŸŒ± æ¤ç‰©</h4>
        <p>å·²è§£é”: <span class="value" id="unlockedPlants">1</span></p>
        <p>æ€»æ¤ç‰©æ•°: <span class="value">24</span></p>
      </div>
    </div>
    
    <div style="margin-top: 20px;">
      <h4>ğŸ“ æ“ä½œè¯´æ˜</h4>
      <p>â€¢ ç‚¹å‡»ç« èŠ‚æ ‡ç­¾åˆ‡æ¢ä¸åŒç« èŠ‚</p>
      <p>â€¢ ç‚¹å‡»å…³å¡å¡ç‰‡é€‰æ‹©å…³å¡ï¼ˆæµ‹è¯•æ¨¡å¼ä¼šæ˜¾ç¤ºå…³å¡ä¿¡æ¯ï¼‰</p>
      <p>â€¢ æ»šåŠ¨é¼ æ ‡æ»šè½®æŸ¥çœ‹æ›´å¤šå…³å¡</p>
      <p>â€¢ ç‚¹å‡»"æ¨¡æ‹Ÿå®Œæˆå½“å‰å…³å¡"å¯ä»¥è§£é”ä¸‹ä¸€å…³å’Œæ¤ç‰©</p>
      <p>â€¢ ç‚¹å‡»"é‡ç½®è¿›åº¦"å¯ä»¥æ¸…ç©ºæ‰€æœ‰è¿›åº¦é‡æ–°å¼€å§‹</p>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { chapterSystem } from './ChapterSystem.js';
    import { ChapterSelect } from './ChapterSelect.js';
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // å½“å‰é€‰æ‹©çš„å…³å¡
    let currentLevelId = null;
    
    // åˆ›å»ºç« èŠ‚é€‰æ‹©ç•Œé¢
    const chapterSelect = new ChapterSelect(canvas, (levelId) => {
      currentLevelId = levelId;
      const level = chapterSystem.getLevel(levelId);
      
      showToast(`é€‰æ‹©å…³å¡: ${level.name}\nåƒµå°¸æ•°: ${level.maxZombies}\né‡‘å¸å¥–åŠ±: ${level.coins}`);
      
      // æµ‹è¯•æ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºå…³å¡ä¿¡æ¯
      console.log('é€‰æ‹©çš„å…³å¡:', level);
    });
    
    // æ˜¾ç¤ºç•Œé¢
    chapterSelect.show();
    
    // æ¸²æŸ“å¾ªç¯
    function render() {
      ctx.fillStyle = '#87CEEB';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // ç»˜åˆ¶èƒŒæ™¯è£…é¥°
      ctx.fillStyle = '#90EE90';
      ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
      
      // å¦‚æœæ²¡æœ‰æ˜¾ç¤ºç« èŠ‚é€‰æ‹©ï¼Œæ˜¾ç¤ºæç¤º
      if (!chapterSelect.visible) {
        ctx.fillStyle = '#FFF';
        ctx.font = 'bold 36px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('ç‚¹å‡»"æ˜¾ç¤º/éšè—ç« èŠ‚é€‰æ‹©"æŸ¥çœ‹ç« èŠ‚ç³»ç»Ÿ', canvas.width / 2, canvas.height / 2);
        
        if (currentLevelId) {
          ctx.font = 'bold 24px Arial';
          ctx.fillText(`å½“å‰é€‰æ‹©: ${currentLevelId}`, canvas.width / 2, canvas.height / 2 + 50);
        }
      }
      
      // ç»˜åˆ¶ç« èŠ‚é€‰æ‹©ç•Œé¢
      chapterSelect.draw(ctx);
      
      requestAnimationFrame(render);
    }
    render();
    
    // æ›´æ–°ä¿¡æ¯é¢æ¿
    function updateInfo() {
      document.getElementById('currentCoins').textContent = chapterSystem.progress.totalCoins;
      document.getElementById('totalCoins').textContent = chapterSystem.progress.earnedCoins;
      document.getElementById('totalStars').textContent = chapterSystem.progress.totalStars;
      document.getElementById('currentChapter').textContent = chapterSystem.progress.currentChapter;
      document.getElementById('completedLevels').textContent = chapterSystem.progress.completedLevels.length;
      document.getElementById('unlockedPlants').textContent = chapterSystem.progress.unlockedPlants.length;
      
      // è®¡ç®—æ»¡æ˜Ÿå…³å¡
      const perfectLevels = chapterSystem.progress.totalStars / 3;
      document.getElementById('perfectLevels').textContent = Math.floor(perfectLevels);
    }
    
    // åˆå§‹æ›´æ–°
    updateInfo();
    
    // ç‚¹å‡»äº‹ä»¶
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      chapterSelect.handleClick(x, y);
      updateInfo();
    });
    
    // æ»šè½®äº‹ä»¶
    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      chapterSelect.handleWheel(e.deltaY);
    }, { passive: false });
    
    // å…¨å±€å‡½æ•°
    window.toggleChapterSelect = function() {
      chapterSelect.toggle();
      updateInfo();
    };
    
    window.showProgress = function() {
      console.log('å½“å‰è¿›åº¦:', chapterSystem.progress);
      
      let message = 'ğŸ“Š å½“å‰è¿›åº¦ï¼š\n\n';
      message += `å½“å‰ç« èŠ‚ï¼šç¬¬ ${chapterSystem.progress.currentChapter} ç« \n`;
      message += `å·²å®Œæˆå…³å¡ï¼š${chapterSystem.progress.completedLevels.length} ä¸ª\n`;
      message += `å·²è§£é”æ¤ç‰©ï¼š${chapterSystem.progress.unlockedPlants.length} ç§\n`;
      message += `æ€»é‡‘å¸ï¼š${chapterSystem.progress.totalCoins}\n`;
      message += `æ€»æ˜Ÿæ˜Ÿï¼š${chapterSystem.progress.totalStars}\n\n`;
      message += `å®Œæˆçš„å…³å¡ï¼š\n${chapterSystem.progress.completedLevels.join(', ')}`;
      
      alert(message);
    };
    
    window.showUnlockedPlants = function() {
      const plants = chapterSystem.getUnlockedPlants();
      console.log('å·²è§£é”æ¤ç‰©:', plants);
      
      let message = 'ğŸŒ± å·²è§£é”æ¤ç‰©ï¼š\n\n';
      plants.forEach((plant, index) => {
        message += `${index + 1}. ${plant}\n`;
      });
      
      alert(message);
    };
    
    window.completeCurrentLevel = function() {
      if (!currentLevelId) {
        showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…³å¡ï¼', true);
        return;
      }
      
      // æ¨¡æ‹Ÿå®Œæˆå…³å¡
      chapterSystem.completeLevel(currentLevelId, 3, 100);
      
      const level = chapterSystem.getLevel(currentLevelId);
      let message = `âœ“ å®Œæˆå…³å¡: ${level.name}\n\n`;
      message += `è·å¾—é‡‘å¸: ${level.coins + 100}\n`;
      message += `è·å¾—æ˜Ÿæ˜Ÿ: 3â­\n`;
      
      if (level.unlockPlant) {
        message += `\nğŸ‰ è§£é”æ–°æ¤ç‰©: ${level.unlockName} ${level.unlockIcon}`;
      }
      
      showToast(message);
      updateInfo();
      
      // æ£€æŸ¥æ˜¯å¦è§£é”æ–°ç« èŠ‚
      const [chapterId, levelNum] = currentLevelId.split('-').map(Number);
      const chapter = chapterSystem.getChapter(chapterId);
      if (levelNum === chapter.levels.length) {
        setTimeout(() => {
          showToast(`ğŸŠ å®Œæˆç¬¬ ${chapterId} ç« æ‰€æœ‰å…³å¡ï¼\nè§£é”ç¬¬ ${chapterId + 1} ç« ï¼`);
        }, 1000);
      }
    };
    
    window.resetProgress = function() {
      if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        chapterSystem.resetProgress();
        currentLevelId = null;
        showToast('è¿›åº¦å·²é‡ç½®ï¼');
        updateInfo();
      }
    };
    
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (isError ? ' error' : '');
      
      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }
    
    // ç›‘å¬è¿›åº¦å˜åŒ–
    setInterval(updateInfo, 1000);
  </script>
</body>
</html>
