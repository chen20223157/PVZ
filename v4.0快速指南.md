# 🚀 v4.0 章节系统 - 快速指南

## 📌 当前状态

### ✅ 已完成的工作

1. **ChapterSystem.js** - 章节系统核心
   - 5大章节定义（草坪、夜晚、泳池、屋顶、终极）
   - 30+关卡数据
   - 24种植物解锁规划
   - 金币系统设计
   - 进度保存/加载

2. **ChapterSelect.js** - 章节选择界面
   - 章节标签切换
   - 关卡卡片显示
   - 解锁状态显示
   - 金币和进度信息
   - 滚动支持

3. **v4.0章节系统设计.md** - 完整设计文档
   - 详细的章节设计
   - 金币系统规划
   - 星级评价设计
   - 开发路线图

---

## 🎯 系统亮点

### 📊 数据对比

| 项目 | v3.0 | v4.0 | 提升 |
|------|------|------|------|
| 章节数 | 1 | 5 | +400% |
| 关卡数 | 10 | 30+ | +200% |
| 植物种类 | 5 | 24+ | +380% |
| 游戏时长 | 30分钟 | 3小时+ | +600% |

### 🌟 新增内容

**5大章节主题：**
```
🌞 草坪 - 白天基础教学
🌙 夜晚 - 资源管理挑战
🏊 泳池 - 地形变化作战
🏠 屋顶 - 斜坡高级战术
🎖️ 终极 - 全植物Boss战
```

**24种植物解锁：**
```
基础9种：豌豆射手、向日葵、坚果墙、土豆地雷、寒冰射手、
        樱桃炸弹、大嘴花、双发射手、火爆辣椒

夜间5种：小太阳、小喷菇、毁灭菇、咖啡豆、地刺

水上4种：莲叶、海蘑菇、冰西瓜、缠绕海草

屋顶4种：三线射手、南瓜护甲、叶子保护伞、磁力菇

终极1种：模仿者（全能）

未来扩展：双子向日葵、火炬树桩、玉米投手、卷心菜投手...
```

**💰 金币系统：**
```
总金币：56,450+ （完成所有关卡）
用途：
  - 植物升级
  - 购买道具
  - 解锁模式
  - 商店购物
```

---

## 📁 文件清单

### 核心文件（已创建）✅

```
ChapterSystem.js           - 章节系统逻辑（630行）
ChapterSelect.js           - 章节选择界面（430行）
v4.0章节系统设计.md        - 完整设计文档
v4.0快速指南.md           - 本文档
```

### 需要集成的文件 🔨

```
Game.js                    - 需要更新以使用新系统
config.js                  - 需要添加新植物配置
Plant.js                   - 需要实现新植物类型
```

### 待创建的文件 📋

```
CoinSystem.js             - 金币系统详细逻辑
StarSystem.js             - 星级评价系统
PlantUpgrade.js           - 植物升级系统
ShopSystem.js             - 商店系统
```

---

## 🔧 如何使用

### 方案1：查看系统（推荐） ⭐

```javascript
// 1. 在浏览器控制台运行
import { chapterSystem } from './ChapterSystem.js';

// 2. 查看所有章节
console.log(chapterSystem.chapters);

// 3. 查看关卡
console.log(chapterSystem.getChapter(1).levels);

// 4. 测试完成关卡
chapterSystem.completeLevel('1-1', 3, 800);
console.log(chapterSystem.progress);
```

### 方案2：创建测试页面

```html
<!-- test-chapter.html -->
<!DOCTYPE html>
<html>
<head>
  <title>章节系统测试</title>
</head>
<body>
  <canvas id="gameCanvas" width="1200" height="800"></canvas>
  
  <script type="module">
    import { chapterSystem } from './ChapterSystem.js';
    import { ChapterSelect } from './ChapterSelect.js';
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // 创建章节选择界面
    const chapterSelect = new ChapterSelect(canvas, (levelId) => {
      console.log('选择关卡:', levelId);
      alert(`准备开始关卡: ${levelId}`);
    });
    
    // 显示界面
    chapterSelect.show();
    
    // 渲染循环
    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      chapterSelect.draw(ctx);
      requestAnimationFrame(render);
    }
    render();
    
    // 点击事件
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      chapterSelect.handleClick(x, y);
    });
    
    // 滚轮事件
    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      chapterSelect.handleWheel(e.deltaY);
    });
  </script>
</body>
</html>
```

---

## 🎮 集成到主游戏

### 第1步：替换关卡系统

在 `Game.js` 中：

```javascript
// 旧代码（v3.0）
import { levelSystem } from './LevelSystem.js';
import { LevelSelect } from './LevelSelect.js';

// 新代码（v4.0）
import { chapterSystem } from './ChapterSystem.js';
import { ChapterSelect } from './ChapterSelect.js';
```

### 第2步：更新构造函数

```javascript
constructor(canvas) {
  // ... 现有代码 ...
  
  // v4.0: 使用章节系统
  this.chapterSystem = chapterSystem;
  this.chapterSelect = new ChapterSelect(
    this.canvas, 
    (levelId) => this.startLevel(levelId)
  );
}
```

### 第3步：更新方法

```javascript
// 开始游戏
startGame() {
  this.chapterSelect.show();
}

// 开始关卡
startLevel(levelId) {
  const levelData = this.chapterSystem.getLevel(levelId);
  if (!levelData) {
    alert('关卡未找到！');
    return;
  }
  
  this.currentLevelData = levelData;
  this.maxZombies = levelData.maxZombies;
  this.sunManager.setSunCount(levelData.startSun);
  
  this.resetGame();
  this.state = GameState.PLAYING;
}

// 完成关卡
win() {
  this.state = GameState.WIN;
  
  if (this.currentLevelData) {
    // 计算星级和金币
    const stars = 3; // TODO: 实际计算
    const coins = 0; // TODO: 实际计算
    
    // 完成关卡
    this.chapterSystem.completeLevel(
      this.currentLevelData.id,
      stars,
      coins
    );
    
    // 显示奖励
    if (this.currentLevelData.unlockPlant) {
      alert(`🎉 解锁新植物：${this.currentLevelData.unlockName}！`);
    }
  }
}
```

---

## 📊 章节预览

### 🌞 第1章：草坪保卫战

```
关卡数：10关
难度：⭐ - ⭐⭐⭐
总金币：13,250
解锁植物：9种

推荐策略：
  前期：豌豆射手 + 向日葵
  中期：+ 坚果墙 + 寒冰射手
  后期：+ 樱桃炸弹 + 火爆辣椒
```

### 🌙 第2章：夜幕降临

```
关卡数：5关
难度：⭐⭐ - ⭐⭐⭐
总金币：8,400
解锁植物：5种

推荐策略：
  核心：小喷菇（廉价输出）
  经济：小太阳（夜间阳光）
  应急：咖啡豆（唤醒蘑菇）
  防御：地刺（地面陷阱）
```

### 🏊 第3章：泳池保卫战

```
关卡数：4关
难度：⭐⭐⭐ - ⭐⭐⭐⭐
总金币：10,000
解锁植物：4种

推荐策略：
  基础：莲叶（水上平台）
  输出：海蘑菇（水下攻击）
  控制：冰西瓜（减速群伤）
  特殊：缠绕海草（水下吞噬）
```

### 🏠 第4章：屋顶危机

```
关卡数：4关
难度：⭐⭐⭐⭐ - ⭐⭐⭐⭐⭐
总金币：14,800
解锁植物：4种

推荐策略：
  输出：三线射手（多线攻击）
  防御：南瓜护甲（额外保护）
  防空：叶子保护伞（防投石）
  特殊：磁力菇（拆金属）
```

### 🎖️ 第5章：最终挑战

```
关卡数：1关
难度：⭐⭐⭐⭐⭐⭐
总金币：10,000
解锁植物：1种（模仿者）

推荐策略：
  全植物可用！
  推荐最强阵容：
    后排：双子向日葵 × 2
    中排：冰西瓜 + 火炬树桩
    前排：南瓜套坚果墙 × 5
    应急：樱桃炸弹 + 火爆辣椒
```

---

## 💡 开发建议

### 优先级1：核心集成 🔥

```
1. 在Game.js中替换为ChapterSystem
2. 更新startLevel和win方法
3. 测试基础流程（选择关卡→游戏→完成→解锁）
4. 确保进度保存正常
```

### 优先级2：新植物实现 ⭐

```
需要实现的新植物（v4.0核心）：
  1. 土豆地雷 - 一击必杀陷阱
  2. 火爆辣椒 - 全行秒杀
  3. 大嘴花 - 近战吞噬
  4. 双发射手 - 双倍伤害

可以先用现有植物替代：
  - 土豆地雷 → 樱桃炸弹
  - 火爆辣椒 → 樱桃炸弹
  - 大嘴花 → 高伤害植物
  - 双发射手 → 豌豆射手×2
```

### 优先级3：金币系统 💰

```
1. 创建CoinSystem.js
2. 在Game.js中集成
3. 完成关卡后发放金币
4. 显示金币余额
5. 未来用于升级和购买
```

---

## 🎯 测试检查清单

### 基础功能测试

- [ ] 章节系统加载正常
- [ ] 章节选择界面显示正常
- [ ] 可以点击选择关卡
- [ ] 未解锁章节显示锁定
- [ ] 未解锁关卡显示锁定
- [ ] 完成关卡后正确解锁下一关
- [ ] 完成关卡后正确解锁植物
- [ ] 金币正确累积
- [ ] 进度正确保存到localStorage
- [ ] 刷新页面后进度正确加载

### 界面测试

- [ ] 章节标签正确显示
- [ ] 关卡卡片正确显示
- [ ] 滚动功能正常
- [ ] 关闭按钮正常
- [ ] Boss关正确标记
- [ ] 完成关卡显示✓标记
- [ ] 金币和星星显示正确
- [ ] 章节进度显示正确

---

## 📚 相关文档

```
v4.0章节系统设计.md    - 完整设计文档（必读）
v3.0更新说明.md        - 前一版本说明
v3.0.1更新日志.md      - 植物解锁调整
豌豆外观更新说明.md     - 视觉效果更新
```

---

## 🎉 总结

### 当前进度

```
✅ 系统框架完成（100%）
✅ 界面设计完成（100%）
✅ 数据设计完成（100%）
🔨 游戏集成进行中（0%）
📋 新植物待实现（0%）
📋 金币系统待实现（0%）
```

### 下一步

1. **立即可做：** 创建 `test-chapter.html` 测试章节系统
2. **优先任务：** 集成到 `Game.js`
3. **中期任务：** 实现核心新植物
4. **长期任务：** 完善金币、升级、商店系统

### 预期效果

完成v4.0后，游戏将从：
- **30分钟游戏** → **3小时+长期游戏**
- **5种植物** → **24+种植物收集**
- **线性关卡** → **多章节探索**
- **一次性游戏** → **重玩价值高**

---

**v4.0 将是一个质的飞跃！让我们开始吧！** 🚀

---

**版本：** v4.0  
**状态：** 框架完成，待集成  
**下一步：** 测试 → 集成 → 扩展
